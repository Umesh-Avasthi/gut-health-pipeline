{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Gut Health App{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'accounts/css/auth.css' %}">
<link rel="stylesheet" href="{% static 'accounts/css/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Welcome Flash Message -->
    <div id="welcome-message" class="welcome-flash-message" style="display: none;">
        <div class="welcome-flash-content">
            <span>Welcome, {{ request.user.first_name|default:request.user.username }} üëã</span>
            <button class="welcome-flash-close" onclick="hideWelcomeMessage()">&times;</button>
        </div>
    </div>
    
    <!-- Tabs Navigation -->
    <div class="dashboard-tabs">
        <button class="tab-button active" onclick="switchTab('upload', this)">Upload New FASTA</button>
        <button class="tab-button" onclick="switchTab('jobs', this)">View Jobs</button>
        <button class="tab-button" onclick="switchTab('profile', this)" style="margin-left: auto;">Profile</button>
    </div>
    
    <!-- Upload Tab Content -->
    <div id="upload-tab" class="tab-content active">
        <div class="upload-tab-content">
            <h2 style="margin: 0 0 0.75rem 0; font-size: 1.3rem;">Upload FASTA Files</h2>
            <p class="subtitle" style="margin-bottom: 1rem; color: var(--text-secondary);">Upload up to 3 FASTA files at once for eggnog analysis</p>
            
            {% if has_running_job %}
            <div class="processing-warning">
                <h4>‚è≥ Processing in Progress</h4>
                <p>
                    <strong>A file is currently being processed:</strong> {{ running_job_info.filename }}<br>
                    Please wait for the current processing to complete before uploading new files.<br>
                    <small>Files are processed one at a time to ensure optimal performance.</small>
                </p>
            </div>
            {% endif %}

            <div class="upload-info">
                <h4>üìã Supported File Formats:</h4>
                <ul>
                    <li>.fasta, .fa, .fas</li>
                    <li>.fna, .ffn, .faa, .frn</li>
                </ul>
                <p style="margin: 0.25rem 0 0 0; font-size: 0.7rem; line-height: 1.3;">
                    <strong>Max file size:</strong> 100MB per file | <strong>Max files:</strong> 3 files at once
                </p>
            </div>

            <form method="POST" action="{% url 'dashboard' %}" enctype="multipart/form-data" class="auth-form" {% if has_running_job %}onsubmit="return false;"{% endif %}>
                {% csrf_token %}
                
                <div class="form-group">
                    <label for="id_files">FASTA Files (Select up to 3 files)</label>
                    <div class="file-input-wrapper {% if has_running_job %}file-input-disabled{% endif %}">
                        <label for="id_files" class="file-input-label">
                            üìÅ Click to select files or drag and drop (up to 3 files)
                            <input type="file" id="id_files" name="files" accept=".fasta,.fa,.fas,.fna,.ffn,.faa,.frn" multiple {% if not has_running_job %}required{% endif %} style="display: none;" onchange="showFileNames(this)" {% if has_running_job %}disabled{% endif %}>
                        </label>
                        <div id="file-names" class="file-name" style="display: none; margin-top: 0.5rem; color: var(--primary-color); font-weight: 500; font-size: 0.85rem;"></div>
                    </div>
                    <small class="form-text text-muted" style="font-size: 0.85rem; color: var(--text-secondary);">You can select multiple files (Ctrl+Click or Cmd+Click) - maximum 3 files</small>
                </div>
                
                <div class="form-group" style="margin-bottom: 1rem;">
                    <label for="id_description" style="font-size: 0.85rem; margin-bottom: 0.4rem;">Description (Optional)</label>
                    {{ upload_form.description }}
                </div>
                
                <button type="submit" class="btn btn-primary {% if has_running_job %}btn-disabled{% endif %}" {% if has_running_job %}disabled{% endif %}>
                    {% if has_running_job %}
                        ‚è≥ Processing in Progress (Upload Disabled)
                    {% else %}
                        Upload & Process
                    {% endif %}
                </button>
            </form>
        </div>
    </div>
        
    <!-- Jobs Tab Content -->
    <div id="jobs-tab" class="tab-content">
        <div class="jobs-tab-content">
            <h2 style="margin: 0 0 1rem 0; font-size: 1.3rem;">My FASTA Jobs</h2>
            {% if jobs %}
                <div style="display: grid; gap: 0.5rem;">
                    {% for job in jobs %}
                    <div class="job-card" style="background: var(--bg-primary); border-radius: var(--border-radius); padding: 0.75rem; box-shadow: var(--shadow); border: 1px solid var(--border-color);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div style="flex: 1; display: flex; align-items: center; gap: 0.5rem;">
                                <h3 style="margin: 0; font-size: 0.9rem; font-weight: 600; color: var(--text-primary);">{{ job.fasta_file.original_filename }}</h3>
                                <span class="status-badge status-{{ job.status }}" style="display: inline-block; padding: 0.15rem 0.4rem; border-radius: 6px; font-size: 0.7rem; font-weight: 500; background: {% if job.status == 'completed' %}#e8f5e9{% elif job.status == 'running' or job.status == 'processing' %}#fff3cd{% elif job.status == 'failed' %}#ffebee{% else %}#e3f2fd{% endif %}; color: {% if job.status == 'completed' %}#2e7d32{% elif job.status == 'running' or job.status == 'processing' %}#856404{% elif job.status == 'failed' %}#c62828{% else %}#1976d2{% endif %}; white-space: nowrap;">
                                    {{ job.status|title }}
                                </span>
                            </div>
                            <div style="display: flex; gap: 0.4rem; flex-wrap: wrap;">
                                {% if job.status == 'completed' %}
                                    <a href="{% url 'fasta_processor:download' job.id %}" class="btn btn-primary" style="padding: 0.4rem 0.75rem; font-size: 0.8rem; width: auto;">Download</a>
                                    {% if job.pathway_file %}
                                    <a href="{% url 'fasta_processor:download_pathway' job.id %}" class="btn btn-secondary" style="padding: 0.4rem 0.75rem; font-size: 0.8rem; width: auto;">Pathway</a>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.4rem; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border-color); font-size: 0.75rem;">
                            <div>
                                <div style="color: var(--text-secondary); font-weight: 500; margin-bottom: 0.15rem; font-size: 0.7rem;">Started</div>
                                <div>{{ job.started_at|date:"M d, Y H:i" }}</div>
                            </div>
                            {% if job.completed_at %}
                            <div>
                                <div style="color: var(--text-secondary); font-weight: 500; margin-bottom: 0.15rem; font-size: 0.7rem;">Completed</div>
                                <div>{{ job.completed_at|date:"M d, Y H:i" }}</div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div style="margin-top: 1rem; text-align: center;">
                    <a href="{% url 'fasta_processor:jobs' %}" class="btn btn-secondary" style="width: auto; padding: 0.75rem 1.5rem;">View All Jobs</a>
                </div>
            {% else %}
                <div class="empty-state" style="text-align: center; padding: 2rem 1rem; color: var(--text-secondary);">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">üìÑ</div>
                    <h3 style="margin: 0.5rem 0; font-size: 1.1rem;">No Jobs Yet</h3>
                    <p style="margin: 0.5rem 0; font-size: 0.9rem;">Upload your first FASTA file to get started!</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Profile Overlay -->
    <div id="profile-overlay" class="profile-overlay" onclick="closeProfilePanel()"></div>
    
    <!-- Profile Tab Content - Right Side Panel -->
    <div id="profile-tab" class="tab-content profile-tab-content">
        <div class="profile-panel-header">
            <h2>Profile</h2>
            <button class="profile-panel-close" onclick="closeProfilePanel()">&times;</button>
        </div>
        <div class="profile-panel-body">
            <div class="profile-header">
                <div class="profile-avatar">
                    {{ request.user.first_name|default:request.user.username|first|upper }}
                </div>
                <h3>{{ request.user.first_name|default:request.user.username }}</h3>
                <p>{{ request.user.email }}</p>
            </div>
            
            <div class="profile-info">
                <div class="profile-info-item">
                    <span class="profile-info-label">Email</span>
                    <span class="profile-info-value">{{ request.user.email }}</span>
                </div>
                <div class="profile-info-item">
                    <span class="profile-info-label">Username</span>
                    <span class="profile-info-value">{{ request.user.username }}</span>
                </div>
                {% if request.user.first_name %}
                <div class="profile-info-item">
                    <span class="profile-info-label">Full Name</span>
                    <span class="profile-info-value">{{ request.user.first_name }}</span>
                </div>
                {% endif %}
                <div class="profile-info-item">
                    <span class="profile-info-label">Member Since</span>
                    <span class="profile-info-value">{{ request.user.date_joined|date:"M d, Y" }}</span>
                </div>
            </div>
            
            <div class="profile-logout-section">
        <form method="post" action="{% url 'logout' %}">
            {% csrf_token %}
                    <button type="submit" class="btn btn-danger" style="width: 100%; padding: 0.5rem; font-size: 0.85rem;">Logout</button>
        </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'accounts/js/dashboard.js' %}"></script>
{% endblock %}
